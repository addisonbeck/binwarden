#!/usr/bin/env bash

install_dependencies () {
  if ! command -v gh
  then
    bw-install-gh
  fi

  if ! command -v ssh-keygen
  then
    bw-install-openssh
  fi
}

generate_key () {
  if [ ! -z "${GH_TOKEN}" ]; then
    echo "No GH_TOKEN environment value found. Please create a GitHub PAT with ssh access and make it availible to your environment."
    exit 0
  fi

  install_dependencies

  mkdir -p $HOME/.ssh
  ssh-keygen -t ed25519-sk -C "Github key auto-generated by binwarden" -f $HOME/.ssh/binwarden-github
  gh ssh-key add $HOME/.ssh/binwarden-github.pub -t "Binwarden Auto-Generated (Auth)"
  gh ssh-key add $HOME/.ssh/binwarden-github.pub -t "Binwarden Auto-Generated (Signing)" --type signing

  git config --global gpg.format ssh
  git config --global user.signingkey $HOME/.ssh/binwarden-github.pub
}

generate_key
